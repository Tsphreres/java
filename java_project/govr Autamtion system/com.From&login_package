package com.Form;

import javax.swing.*;
import com.panel.userpanel;
import com.panel.dashboardpanel;
import com.panel.securtypanel;
import java.awt.*;
import java.awt.event.ActionEvent;
import java.awt.event.ActionListener;
import java.sql.*;
import java.util.EventListener;

public class LoginForm extends JFrame {
    private JTextField nameField;
    private JPasswordField passwordField;
    private JButton loginButton;
    private JLabel messageLabel;
    private JCheckBox showPasswordCheckbox;
    private String userRole; 

    public LoginForm() {
        initializeUI();
    }

    private void initializeUI() {
        setTitle("Repuburi y'Urwanda");
        setDefaultCloseOperation(JFrame.EXIT_ON_CLOSE);
        setSize(350, 350); 
        setLocationRelativeTo(null);
        setResizable(false);

        JPanel mainPanel = new JPanel();
        mainPanel.setLayout(new GridBagLayout());
        mainPanel.setBorder(BorderFactory.createLineBorder(Color.green, 1));
        mainPanel.setBackground(new Color(0, 0, 139));
        GridBagConstraints gbc = new GridBagConstraints();
        gbc.insets = new Insets(12, 12, 12, 12);
        gbc.fill = GridBagConstraints.HORIZONTAL;

        JLabel titleLabel = new JLabel("SISITEME Y'UMUTEKANO", JLabel.CENTER);
        titleLabel.setFont(new Font("Arial", Font.BOLD, 20));
        titleLabel.setForeground(Color.YELLOW);
        gbc.gridx = 0;
        gbc.gridy = 0;
        gbc.gridwidth = 2;
        gbc.insets = new Insets(0, 0, 20, 0);
        mainPanel.add(titleLabel, gbc);

        gbc.insets = new Insets(8, 8, 8, 8);

        JLabel nameLabel = new JLabel("Amazina");
        nameLabel.setFont(new Font("Arial", Font.BOLD, 12));
        nameLabel.setForeground(Color.WHITE);
        gbc.gridx = 0;
        gbc.gridy = 1;
        gbc.gridwidth = 1;
        gbc.anchor = GridBagConstraints.LINE_END;
        mainPanel.add(nameLabel, gbc);

        nameField = new JTextField(20);
        nameField.setFont(new Font("Arial", Font.PLAIN, 12));
        nameField.setBackground(Color.WHITE);
        nameField.setForeground(Color.BLACK);
        nameField.setBorder(BorderFactory.createLineBorder(Color.YELLOW, 1));
        gbc.gridx = 1;
        gbc.gridy = 1;
        gbc.anchor = GridBagConstraints.LINE_START;
        mainPanel.add(nameField, gbc);

        JLabel passwordLabel = new JLabel("ijambo BANGA");
        passwordLabel.setFont(new Font("Arial", Font.BOLD, 12));
        passwordLabel.setForeground(Color.WHITE);
        gbc.gridx = 0;
        gbc.gridy = 2;
        gbc.anchor = GridBagConstraints.LINE_END;
        mainPanel.add(passwordLabel, gbc);

        JPanel passwordPanel = new JPanel(new BorderLayout());
        passwordPanel.setBackground(Color.WHITE);
        
        passwordField = new JPasswordField(15);
        passwordField.setFont(new Font("Arial", Font.PLAIN, 12));
        passwordField.setBackground(Color.WHITE);
        passwordField.setForeground(Color.BLACK);
        passwordField.setBorder(BorderFactory.createLineBorder(Color.YELLOW, 1));
        passwordPanel.add(passwordField, BorderLayout.CENTER);
        
        final JButton togglePasswordButton = new JButton("üëÅ");
        togglePasswordButton.setFont(new Font("Arial", Font.PLAIN, 12));
        togglePasswordButton.setBackground(Color.WHITE);
        togglePasswordButton.setForeground(Color.BLACK);
        togglePasswordButton.setBorder(BorderFactory.createLineBorder(Color.YELLOW, 1));
        togglePasswordButton.setFocusPainted(false);
        togglePasswordButton.setPreferredSize(new Dimension(40, passwordField.getPreferredSize().height));
        
        togglePasswordButton.addActionListener(new ActionListener() {
            private boolean passwordVisible = false;
            
            @Override
            public void actionPerformed(ActionEvent e) {
                passwordVisible = !passwordVisible;
                
                if (passwordVisible) {
                    passwordField.setEchoChar((char) 0);
                    togglePasswordButton.setText("üôà");
                    togglePasswordButton.setToolTipText("Hide Password");
                } else {
                    passwordField.setEchoChar('‚Ä¢');
                    togglePasswordButton.setText("üëÅ");
                    togglePasswordButton.setToolTipText("Show Password");
                }
            }
        });
        
        passwordPanel.add(togglePasswordButton, BorderLayout.EAST);
        
        gbc.gridx = 1;
        gbc.gridy = 2;
        gbc.anchor = GridBagConstraints.LINE_START;
        mainPanel.add(passwordPanel, gbc);

        showPasswordCheckbox = new JCheckBox("Reba ijambo banga");
        showPasswordCheckbox.setFont(new Font("Arial", Font.PLAIN, 11));
        showPasswordCheckbox.setForeground(Color.YELLOW);
        showPasswordCheckbox.setBackground(new Color(0, 0, 139));
        showPasswordCheckbox.setFocusPainted(false);
        
        showPasswordCheckbox.addActionListener(new ActionListener() {
            @Override
            public void actionPerformed(ActionEvent e) {
                if (showPasswordCheckbox.isSelected()) {
                    passwordField.setEchoChar((char) 0);
                } else {
                    passwordField.setEchoChar('‚Ä¢');
                }
            }
        });
        
        gbc.gridx = 1;
        gbc.gridy = 3;
        gbc.anchor = GridBagConstraints.LINE_START;
        gbc.insets = new Insets(5, 0, 15, 0);
        mainPanel.add(showPasswordCheckbox, gbc);

        loginButton = new JButton("KWINJIRA");
        loginButton.setFont(new Font("Arial", Font.BOLD, 14));
        loginButton.setBackground(Color.BLACK);
        loginButton.setForeground(Color.YELLOW);
        loginButton.setFocusPainted(false);
        loginButton.setBorder(BorderFactory.createCompoundBorder(
            BorderFactory.createLineBorder(Color.GREEN, 2),
            BorderFactory.createEmptyBorder(10, 25, 10, 25)
        ));
        gbc.gridx = 0;
        gbc.gridy = 4;
        gbc.gridwidth = 2;
        gbc.fill = GridBagConstraints.NONE;
        gbc.anchor = GridBagConstraints.CENTER;
        gbc.insets = new Insets(10, 0, 10, 0);
        mainPanel.add(loginButton, gbc);

        messageLabel = new JLabel("", JLabel.CENTER);
        messageLabel.setFont(new Font("Arial", Font.PLAIN, 12));
        messageLabel.setForeground(Color.YELLOW);
        gbc.gridx = 0;
        gbc.gridy = 5;
        gbc.insets = new Insets(5, 0, 0, 0);
        mainPanel.add(messageLabel, gbc);

        loginButton.addActionListener(new LoginButtonListener());

        passwordField.addActionListener(new LoginButtonListener());

        add(mainPanel);
        
        getContentPane().setBackground(new Color(0, 0, 139));
        
        setupKeyboardShortcuts();
    }

    private void setupKeyboardShortcuts() {
        KeyStroke toggleKey = KeyStroke.getKeyStroke("control shift P");
        passwordField.getInputMap(JComponent.WHEN_IN_FOCUSED_WINDOW).put(toggleKey, "togglePassword");
        passwordField.getActionMap().put("togglePassword", new AbstractAction() {
            @Override
            public void actionPerformed(ActionEvent e) {
                showPasswordCheckbox.setSelected(!showPasswordCheckbox.isSelected());
            }
        });
    }

    private class LoginButtonListener implements ActionListener {
        @Override
        public void actionPerformed(ActionEvent e) {
            final String name = nameField.getText().trim();
            final String password = new String(passwordField.getPassword());

            if (name.isEmpty() || password.isEmpty()) {
                messageLabel.setText("IJAMBO BANGA Cg IZINA SIBYO");
                messageLabel.setForeground(Color.YELLOW);
                return;
            }

            loginButton.setText("Logging in...");
            loginButton.setEnabled(false);
            loginButton.setBackground(Color.ORANGE);
            messageLabel.setText("Authenticating...");
            messageLabel.setForeground(Color.YELLOW);

            SwingWorker<String, Void> worker = new SwingWorker<String, Void>() {
                @Override
                protected String doInBackground() throws Exception {
                    return validateCredentials(name, password);
                }

                @Override
                protected void done() {
                    try {
                        String result = get();
                        
                        if (result.startsWith("MATCH:")) {
                            messageLabel.setForeground(Color.GREEN);
                            messageLabel.setText("Login successful! Redirecting...");
                            
                            final String role = result.split(":")[1];
                            userRole = role;
                            
                            LoginForm.this.dispose();
                            
                            SwingUtilities.invokeLater(new Runnable() {
                                @Override
                                public void run() {
                                    createMainApplicationFrame(role);
                                }
                            });
                            
                        } else {
                            messageLabel.setForeground(Color.YELLOW);
                            messageLabel.setText(result);
                            loginButton.setText("KWINJIRA");
                            loginButton.setEnabled(true);
                            loginButton.setBackground(Color.BLACK);
                        }
                    } catch (Exception ex) {
                        messageLabel.setForeground(Color.YELLOW);
                        messageLabel.setText("IKOSA KWINJIRA: " + ex.getMessage());
                        loginButton.setText("KWINJIRA");
                        loginButton.setEnabled(true);
                        loginButton.setBackground(Color.BLACK);
                        ex.printStackTrace();
                    }
                }
            };
            
            worker.execute();
        }
    }

    private void createMainApplicationFrame(String role) {
        JFrame mainFrame = new JFrame("Repuburi y'Urwanda");
        mainFrame.setDefaultCloseOperation(JFrame.EXIT_ON_CLOSE);
        mainFrame.setSize(900, 700);
        mainFrame.setLocationRelativeTo(null);
        mainFrame.setExtendedState(JFrame.MAXIMIZED_BOTH);
        
        EventListener userPanel;
        String panelTitle = "";
        
        switch (role.toLowerCase()) {
            case "admin":
                userPanel = new userpanel();
                panelTitle = "Admin Panel - User Management";
                break;
            case "mayor":
                userPanel = new dashboardpanel(mainFrame);
                panelTitle = "Mayor Panel - Security Dashboard";
                break;
            case "security":
                userPanel = new securtypanel(mainFrame);
                panelTitle = "Security Panel - Reports Management";
                break;
            default:
                userPanel = new userpanel();
                panelTitle = "User Panel";
                JOptionPane.showMessageDialog(null, 
                    "Unknown role: " + role + ". Defaulting to Admin panel.", 
                    "Role Warning", 
                    JOptionPane.WARNING_MESSAGE);
                break;
        }
        
        mainFrame.setTitle("Government Security Report System - " + panelTitle);
        
        mainFrame.add((Component) userPanel);
        mainFrame.setVisible(true);
        
        JOptionPane.showMessageDialog(mainFrame, 
            "MUHAWE IKAZE : " + role.toUpperCase(), 
            "MWINJIYE NEZA", 
            JOptionPane.INFORMATION_MESSAGE);
    }

    private String validateCredentials(String name, String password) {
        Connection conn = null;
        PreparedStatement pstmt = null;
        ResultSet rs = null;

        try {
            Class.forName("com.mysql.cj.jdbc.Driver");

            String url = "jdbc:mysql://localhost:3306/dbgov_system";
            String dbUsername = "root";
            String dbPassword = "";

            conn = DriverManager.getConnection(url, dbUsername, dbPassword);

            String sql = "SELECT id, names, role FROM user WHERE names = ? AND password = ?";
            pstmt = conn.prepareStatement(sql);
            pstmt.setString(1, name);
            pstmt.setString(2, password);

            rs = pstmt.executeQuery();

            if (rs.next()) {
                String userRole = rs.getString("role");
                String userName = rs.getString("names");
                int userId = rs.getInt("id");
                
                System.out.println("User logged in: " + userName + " (ID: " + userId + ", Role: " + userRole + ")");
                
                return "MATCH:" + userRole;
            } else {
                return "IJAMBO BANGA N'IZINA SIBYO";
            }

        } catch (ClassNotFoundException e) {
            return "Database driver not found: " + e.getMessage();
        } catch (SQLException e) {
            return "Database connection error: " + e.getMessage();
        } finally {
            try {
                if (rs != null) rs.close();
                if (pstmt != null) pstmt.close();
                if (conn != null) conn.close();
            } catch (SQLException e) {
                e.printStackTrace();
            }
        }
    }

    public String getUserRole() {
        return userRole;
    }

    public static void main(String[] args) {
        try {
            UIManager.setLookAndFeel(UIManager.getLookAndFeel());
            
            UIManager.put("Button.focus", new Color(0, 0, 0, 0));
            UIManager.put("TextField.inactiveBackground", Color.WHITE);
            
        } catch (Exception e) {
            e.printStackTrace();
        }

        SwingUtilities.invokeLater(new Runnable() {
            @Override
            public void run() {
                LoginForm loginForm = new LoginForm();
                loginForm.setVisible(true);
                
                System.out.println("Starting Government Security System...");
                System.out.println("Database: dbgov_system");
                System.out.println("Default roles: admin, mayor, security");
                System.out.println("Password toggle: Click eye icon or check 'Reba ijambo banga'");
                System.out.println("Keyboard shortcut: Ctrl+Shift+P to toggle password visibility");
            }
        });
    }
}
