package com.panel;

import java.awt.Color;
import java.awt.Component;
import java.awt.FlowLayout;
import java.awt.Font;
import java.awt.event.ActionEvent;
import java.awt.event.ActionListener;
import java.awt.event.MouseAdapter;
import java.awt.event.MouseEvent;
import java.sql.Connection;
import java.sql.PreparedStatement;
import java.sql.ResultSet;

import javax.swing.JButton;
import javax.swing.JComboBox;
import javax.swing.JComponent;
import javax.swing.JFrame;
import javax.swing.JLabel;
import javax.swing.JOptionPane;
import javax.swing.JPanel;
import javax.swing.JPasswordField;
import javax.swing.JScrollPane;
import javax.swing.JTable;
import javax.swing.JTextField;
import javax.swing.BorderFactory;
import javax.swing.table.DefaultTableCellRenderer;
import javax.swing.table.DefaultTableModel;
import javax.swing.table.JTableHeader;

import com.Form.LoginForm;

public class userpanel extends JPanel implements ActionListener {

    private JTextField idTxt, nameTxt, phoneTxt, emailTxt;
    private JPasswordField passTxt;
    private JComboBox<String> roleComboBox;
    private JButton addBtn, updateBtn, deleteBtn, loadBtn;
    private JTable table;
    private DefaultTableModel model;
    
    private JButton securityBtn, dashboardBtn, userBtn, logoutBtn;
    private JFrame parentFrame;
    
    private final Color DARK_BLUE_BG = new Color(0, 0, 139); 
    private final Color BLACK_TABLE_BG = Color.BLACK; 
    private final Color YELLOW_TEXT = Color.YELLOW; 
    private final Color GREEN_BUTTON = Color.GREEN; 
    private final Color RED_BUTTON = new Color(200, 0, 0);
    
    private final Color[] COLUMN_COLORS = {
        new Color(30, 30, 60),     
        new Color(60, 30, 30),     
        new Color(30, 60, 30),     
        new Color(60, 60, 30),     
        new Color(60, 30, 60),     
        new Color(30, 60, 60)      
    };
    
    private final Color[] HEADER_COLORS = {
        new Color(0, 100, 0),      
        new Color(0, 120, 0),      
        new Color(0, 140, 0),      
        new Color(0, 160, 0),      
        new Color(0, 180, 0),     
        new Color(0, 200, 0)       
    };

    public userpanel(JFrame parentFrame) {
        this.parentFrame = parentFrame;
        setLayout(null);
        setBackground(DARK_BLUE_BG); 
        createNavigationBar();
        createLogoutButton();
        initializeComponents();
        loadUsers(); 
    }

    public userpanel() {
        this(null);
    }

    private void initializeComponents() {
       
        JLabel titleLabel = new JLabel("Repuburi y'Urwanda");
        titleLabel.setBounds(20, 50, 300, 30);
        titleLabel.setFont(new Font("Arial", Font.BOLD, 18));
        titleLabel.setForeground(YELLOW_TEXT); 
        add(titleLabel);

        
        idTxt = new JTextField();
        nameTxt = new JTextField();
        phoneTxt = new JTextField();
        emailTxt = new JTextField();
        passTxt = new JPasswordField();
        
        
        String[] roles = {"admin", "mayor", "security"};
        roleComboBox = new JComboBox<>(roles);
        roleComboBox.setSelectedIndex(0);

       
        addBtn = new JButton("Add User");
        updateBtn = new JButton("Update User");
        deleteBtn = new JButton("Delete User");
        loadBtn = new JButton("Refresh Data");

       
        int y = 80;
        addField("ID:", idTxt, y); y += 30;
        addField("Username:", nameTxt, y); y += 30;
        addField("Password:", passTxt, y); y += 30;
        addField("Phone:", phoneTxt, y); y += 30;
        addField("Email:", emailTxt, y); y += 30;
        addComboField("Role:", roleComboBox, y); y += 40;

     
        addButtons();

       
        String[] labels = {"ID", "Username", "Password", "Phone", "Email", "Role"};
        model = new DefaultTableModel(labels, 0) {
            @Override
            public boolean isCellEditable(int row, int column) {
                return false;
            }
        };
        
        table = new JTable(model);
        table.setRowHeight(25);
        table.setBackground(BLACK_TABLE_BG); 
        table.setForeground(Color.WHITE); 
        table.setGridColor(Color.BLACK); 
        table.setShowGrid(false); 
        table.setIntercellSpacing(new java.awt.Dimension(0, 0)); 
        table.setSelectionBackground(new Color(0, 100, 0)); 
        table.setSelectionForeground(YELLOW_TEXT); 
        
       
        table.setDefaultRenderer(Object.class, new DefaultTableCellRenderer() {
            @Override
            public Component getTableCellRendererComponent(JTable table, Object value,
                    boolean isSelected, boolean hasFocus, int row, int column) {
                
                Component cell = super.getTableCellRendererComponent(table, value, 
                        isSelected, hasFocus, row, column);
                
               
                setBorder(BorderFactory.createEmptyBorder());
                
                if (!isSelected) {
                  
                    if (column < COLUMN_COLORS.length) {
                        cell.setBackground(COLUMN_COLORS[column]);
                    } else {
                        cell.setBackground(Color.DARK_GRAY);
                    }
                    cell.setForeground(Color.WHITE);
                } else {
                    cell.setBackground(new Color(0, 100, 0)); 
                    cell.setForeground(YELLOW_TEXT); 
                }
                
                return cell;
            }
        });
        
       
        JTableHeader header = table.getTableHeader();
        header.setDefaultRenderer(new DefaultTableCellRenderer() {
            @Override
            public Component getTableCellRendererComponent(JTable table, Object value,
                    boolean isSelected, boolean hasFocus, int row, int column) {
                
                super.getTableCellRendererComponent(table, value, isSelected, hasFocus, row, column);
                
              
                if (column < HEADER_COLORS.length) {
                    setBackground(HEADER_COLORS[column]);
                } else {
                    setBackground(new Color(0, 150, 0));
                }
                
                setForeground(Color.BLACK); 
                setFont(new Font("Arial", Font.BOLD, 12));
                setHorizontalAlignment(JLabel.CENTER);
                
                
                setBorder(BorderFactory.createEmptyBorder());
                
                return this;
            }
        });
        
        JScrollPane sp = new JScrollPane(table);
        sp.setBounds(20, 280, 750, 150);
        sp.getViewport().setBackground(BLACK_TABLE_BG); 
        
        
        sp.setBorder(BorderFactory.createEmptyBorder());
        
        add(sp);

       
        table.addMouseListener(new MouseAdapter() {
            @Override
            public void mouseClicked(MouseEvent e) {
                int selectedRow = table.getSelectedRow();
                if (selectedRow >= 0) {
                    idTxt.setText(model.getValueAt(selectedRow, 0).toString());
                    nameTxt.setText(model.getValueAt(selectedRow, 1).toString());
                    passTxt.setText(model.getValueAt(selectedRow, 2).toString());
                    phoneTxt.setText(model.getValueAt(selectedRow, 3).toString());
                    emailTxt.setText(model.getValueAt(selectedRow, 4).toString());
                    roleComboBox.setSelectedItem(model.getValueAt(selectedRow, 5).toString());
                }
            }
        });
    }

    private void createNavigationBar() {
       
        JPanel navPanel = new JPanel();
        navPanel.setBounds(0, 0, 800, 40);
        navPanel.setBackground(Color.BLACK);
        navPanel.setLayout(new FlowLayout(FlowLayout.LEFT));
        
       
        securityBtn = new JButton("Security");
        dashboardBtn = new JButton("Dashboard");
        userBtn = new JButton("Users");
        
      
        securityBtn.setBackground(GREEN_BUTTON);
        securityBtn.setForeground(Color.BLACK);
        securityBtn.setBorder(BorderFactory.createEmptyBorder()); 
        securityBtn.setFont(new Font("Arial", Font.BOLD, 12));
        
        dashboardBtn.setBackground(GREEN_BUTTON);
        dashboardBtn.setForeground(Color.BLACK);
        dashboardBtn.setBorder(BorderFactory.createEmptyBorder()); 
        dashboardBtn.setFont(new Font("Arial", Font.BOLD, 12));
        
       
        userBtn.setBackground(GREEN_BUTTON);
        userBtn.setForeground(Color.BLACK);
        userBtn.setBorder(BorderFactory.createEmptyBorder()); 
        userBtn.setFont(new Font("Arial", Font.BOLD, 12));
        
       
        securityBtn.addActionListener(this);
        dashboardBtn.addActionListener(this);
        userBtn.addActionListener(this);
        
        
        navPanel.add(securityBtn);
        navPanel.add(dashboardBtn);
        navPanel.add(userBtn);
        
        add(navPanel);
    }

    private void createLogoutButton() {
        logoutBtn = new JButton("Gusohoka");
        logoutBtn.setBounds(670, 5, 100, 30);
        logoutBtn.setBackground(RED_BUTTON);
        logoutBtn.setForeground(Color.WHITE);
        logoutBtn.setFont(new Font("Arial", Font.BOLD, 12));
        logoutBtn.setBorder(BorderFactory.createEmptyBorder());
        logoutBtn.setFocusPainted(false);
        logoutBtn.addActionListener(new ActionListener() {
            @Override
            public void actionPerformed(ActionEvent e) {
                logoutUser();
            }
        });
        add(logoutBtn);
    }

    private void addField(String lbl, JComponent txt, int y) {
        JLabel l = new JLabel(lbl);
        l.setBounds(20, y, 80, 25);
        l.setForeground(YELLOW_TEXT); 
        l.setFont(new Font("Arial", Font.BOLD, 12));
        txt.setBounds(110, y, 180, 25);
        txt.setBackground(Color.WHITE);
        txt.setForeground(Color.BLACK);
        txt.setBorder(BorderFactory.createEmptyBorder());
        add(l);
        add(txt);
    }

    private void addComboField(String lbl, JComboBox<String> combo, int y) {
        JLabel l = new JLabel(lbl);
        l.setBounds(20, y, 80, 25);
        l.setForeground(YELLOW_TEXT);
        l.setFont(new Font("Arial", Font.BOLD, 12));
        combo.setBounds(110, y, 180, 25);
        combo.setBackground(Color.WHITE);
        combo.setForeground(Color.BLACK);
        combo.setBorder(BorderFactory.createEmptyBorder());
        add(l);
        add(combo);
    }

    private void addButtons() {
        addBtn.setBounds(320, 80, 120, 30);
        updateBtn.setBounds(320, 120, 120, 30);
        deleteBtn.setBounds(320, 160, 120, 30);
        loadBtn.setBounds(320, 200, 120, 30);

        
        styleButton(addBtn);
        styleButton(updateBtn);
        styleButton(deleteBtn);
        styleButton(loadBtn);

        add(addBtn);
        add(updateBtn);
        add(deleteBtn);
        add(loadBtn);

        addBtn.addActionListener(this);
        updateBtn.addActionListener(this);
        deleteBtn.addActionListener(this);
        loadBtn.addActionListener(this);

      
        JButton clearBtn = new JButton("Clear Form");
        clearBtn.setBounds(470, 80, 120, 30);
        styleButton(clearBtn);
        clearBtn.addActionListener(new ActionListener() {
            @Override
            public void actionPerformed(ActionEvent e) {
                clearFields();
            }
        });
        add(clearBtn);
    }
    
    private void styleButton(JButton button) {
        button.setBackground(GREEN_BUTTON);
        button.setForeground(Color.BLACK);
        button.setBorder(BorderFactory.createEmptyBorder());
        button.setFont(new Font("Arial", Font.BOLD, 12));
        button.setFocusPainted(false);
    }

    @Override
    public void actionPerformed(ActionEvent e) {
       
        if (e.getSource() == securityBtn) {
            switchToPanel("security");
        } else if (e.getSource() == dashboardBtn) {
            switchToPanel("dashboard");
        } else if (e.getSource() == userBtn) {
            loadUsers();
        }
       
        else if (e.getSource() == addBtn) {
            addUser();
        } else if (e.getSource() == updateBtn) {
            updateUser();
        } else if (e.getSource() == deleteBtn) {
            deleteUser();
        } else if (e.getSource() == loadBtn) {
            loadUsers();
        }
    }

    private void logoutUser() {
        int confirm = JOptionPane.showConfirmDialog(this,
            "Are you sure you want to logout?",
            "Confirm Logout",
            JOptionPane.YES_NO_OPTION);
        
        if (confirm == JOptionPane.YES_OPTION) {
            if (parentFrame != null) {
                parentFrame.dispose();
                openLoginForm();
            } else {
                JOptionPane.showMessageDialog(this,
                    "Logged out successfully!",
                    "Logout",
                    JOptionPane.INFORMATION_MESSAGE);
                System.exit(0);
            }
        }
    }

    private void openLoginForm() {
        try {
            javax.swing.SwingUtilities.invokeLater(new Runnable() {
                @Override
                public void run() {
                    LoginForm loginForm = new LoginForm();
                    loginForm.setVisible(true);
                }
            });
        } catch (Exception e) {
            e.printStackTrace();
            JOptionPane.showMessageDialog(null,
                "Error opening login form: " + e.getMessage(),
                "Error",
                JOptionPane.ERROR_MESSAGE);
            System.exit(0);
        }
    }

    private void addUser() {
        if (!validateInput()) {
            return;
        }

        try (Connection con = com.util.db.getConnection()) {
            
            String checkSql = "SELECT id FROM user WHERE names = ?";
            PreparedStatement checkPs = con.prepareStatement(checkSql);
            checkPs.setString(1, nameTxt.getText().trim());
            ResultSet rs = checkPs.executeQuery();

            if (rs.next()) {
                JOptionPane.showMessageDialog(this,
                    "Username '" + nameTxt.getText() + "' already exists!",
                    "Duplicate Username",
                    JOptionPane.WARNING_MESSAGE);
                return;
            }

           
            String sql = "INSERT INTO user (names, password, phone, email, role) VALUES (?, ?, ?, ?, ?)";
            PreparedStatement ps = con.prepareStatement(sql);
            ps.setString(1, nameTxt.getText().trim());
            ps.setString(2, new String(passTxt.getPassword()));
            ps.setString(3, phoneTxt.getText().trim());
            ps.setString(4, emailTxt.getText().trim());
            ps.setString(5, roleComboBox.getSelectedItem().toString());

            int rowsAffected = ps.executeUpdate();
            if (rowsAffected > 0) {
                JOptionPane.showMessageDialog(this, 
                    "User added successfully!\nUsername: " + nameTxt.getText(),
                    "Success", 
                    JOptionPane.INFORMATION_MESSAGE);
                clearFields();
                loadUsers();
            }

        } catch (Exception ex) {
            ex.printStackTrace();
            JOptionPane.showMessageDialog(this, 
                "Error adding user: " + ex.getMessage(), 
                "Database Error", 
                JOptionPane.ERROR_MESSAGE);
        }
    }

    private void updateUser() {
        if (idTxt.getText().trim().isEmpty()) {
            JOptionPane.showMessageDialog(this, 
                "Please select a user to update from the table.", 
                "No Selection", 
                JOptionPane.WARNING_MESSAGE);
            return;
        }

        if (!validateInput()) {
            return;
        }

        try (Connection con = com.util.db.getConnection()) {
            String sql = "UPDATE user SET names=?, password=?, phone=?, email=?, role=? WHERE id=?";
            PreparedStatement ps = con.prepareStatement(sql);
            ps.setString(1, nameTxt.getText().trim());
            ps.setString(2, new String(passTxt.getPassword()));
            ps.setString(3, phoneTxt.getText().trim());
            ps.setString(4, emailTxt.getText().trim());
            ps.setString(5, roleComboBox.getSelectedItem().toString());
            ps.setInt(6, Integer.parseInt(idTxt.getText().trim()));

            int rowsAffected = ps.executeUpdate();
            if (rowsAffected > 0) {
                JOptionPane.showMessageDialog(this, "User updated successfully!");
                clearFields();
                loadUsers();
            } else {
                JOptionPane.showMessageDialog(this, "No user found with the specified ID.");
            }

        } catch (Exception ex) {
            ex.printStackTrace();
            JOptionPane.showMessageDialog(this, 
                "Error updating user: " + ex.getMessage(), 
                "Database Error", 
                JOptionPane.ERROR_MESSAGE);
        }
    }

    private void deleteUser() {
        if (idTxt.getText().trim().isEmpty()) {
            JOptionPane.showMessageDialog(this, 
                "Please select a user to delete from the table.", 
                "No Selection", 
                JOptionPane.WARNING_MESSAGE);
            return;
        }

        int confirm = JOptionPane.showConfirmDialog(this,
            "Are you sure you want to delete user: " + nameTxt.getText() + "?",
            "Confirm Delete",
            JOptionPane.YES_NO_OPTION,
            JOptionPane.WARNING_MESSAGE);

        if (confirm == JOptionPane.YES_OPTION) {
            try (Connection con = com.util.db.getConnection()) {
              
                String sql = "DELETE FROM user WHERE id=?";
                PreparedStatement ps = con.prepareStatement(sql);
                ps.setInt(1, Integer.parseInt(idTxt.getText().trim()));

                int rowsAffected = ps.executeUpdate();
                if (rowsAffected > 0) {
                    JOptionPane.showMessageDialog(this, "User deleted successfully!");
                    clearFields();
                    loadUsers();
                } else {
                    JOptionPane.showMessageDialog(this, "No user found with the specified ID.");
                }

            } catch (Exception ex) {
                ex.printStackTrace();
                JOptionPane.showMessageDialog(this, 
                    "Error deleting user: " + ex.getMessage(), 
                    "Database Error", 
                    JOptionPane.ERROR_MESSAGE);
            }
        }
    }

    private void loadUsers() {
        try (Connection con = com.util.db.getConnection()) {
            model.setRowCount(0);
            String sql = "SELECT id, names, password, phone, email, role FROM user ORDER BY id";
            ResultSet rs = con.createStatement().executeQuery(sql);
            
            int count = 0;
            while (rs.next()) {
                count++;
                model.addRow(new Object[]{
                    rs.getInt("id"),
                    rs.getString("names"),
                    rs.getString("password"),
                    rs.getString("phone"),
                    rs.getString("email"),
                    rs.getString("role")
                });
            }
            
            if (count == 0) {
                JOptionPane.showMessageDialog(this, "No users found in database.");
            }
            
        } catch (Exception ex) {
            ex.printStackTrace();
            JOptionPane.showMessageDialog(this, 
                "Error loading users: " + ex.getMessage(), 
                "Database Error", 
                JOptionPane.ERROR_MESSAGE);
        }
    }

    private boolean validateInput() {
        if (nameTxt.getText().trim().isEmpty()) {
            JOptionPane.showMessageDialog(this, "Please enter username.");
            nameTxt.requestFocus();
            return false;
        }
        if (new String(passTxt.getPassword()).trim().isEmpty()) {
            JOptionPane.showMessageDialog(this, "Please enter password.");
            passTxt.requestFocus();
            return false;
        }
        if (phoneTxt.getText().trim().isEmpty()) {
            JOptionPane.showMessageDialog(this, "Please enter phone number.");
            phoneTxt.requestFocus();
            return false;
        }
        if (emailTxt.getText().trim().isEmpty()) {
            JOptionPane.showMessageDialog(this, "Please enter email address.");
            emailTxt.requestFocus();
            return false;
        }
        return true;
    }

    private void clearFields() {
        idTxt.setText("");
        nameTxt.setText("");
        passTxt.setText("");
        phoneTxt.setText("");
        emailTxt.setText("");
        roleComboBox.setSelectedIndex(0);
        table.clearSelection();
    }

    private void switchToPanel(String panelName) {
        if (parentFrame == null) {
            JOptionPane.showMessageDialog(this, 
                "Parent frame not available for navigation.");
            return;
        }

        parentFrame.getContentPane().removeAll();
        JPanel newPanel;

       
        if (panelName.equalsIgnoreCase("security")) {
            newPanel = new securtypanel(parentFrame);
        } else if (panelName.equalsIgnoreCase("dashboard")) {
            newPanel = new dashboardpanel(parentFrame);
        } else {
            newPanel = new userpanel(parentFrame);
        }

        parentFrame.add(newPanel);
        parentFrame.revalidate();
        parentFrame.repaint();
    }

    public static void main(String[] args) {
        JFrame frame = new JFrame("Repubulika y'Urwanda");
        frame.setDefaultCloseOperation(JFrame.EXIT_ON_CLOSE);
        frame.setSize(800, 600);
        
       
        frame.getRootPane().setBorder(BorderFactory.createEmptyBorder());
        
        userpanel panel = new userpanel(frame);
        frame.add(panel);
        frame.setVisible(true);
    }
}
